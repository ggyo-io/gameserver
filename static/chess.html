<DOCTYPE html>
<html lang="en">
<head>
<title>Chess</title>
<link rel="stylesheet" href="/static/css/chessboard-0.3.0.min.css" />
</head>
<body>
<div id="board" style="float: left; margin-left: 5px; width: 400px"></div>
<input type="button" id="startBtn" value="Start" />
<input type="button" id="clearBtn" value="Clear" />
<p>Status: <span id="status"></span></p>
<p>FEN: <span id="fen"></span></p>
<p>PGN: <span id="pgn"></span></p>
<p>Opponent: <span id="foe"></span></p>
<p>Color: <span id="color"></span></p>

<script src="/static/js/json3.min.js"></script>
<script src="/static/js/jquery-1.10.1.min.js"></script>
<script src="/static/js/chessboard-0.3.0.min.js"></script>
<script src="/static/js/chess.min.js"></script>
<script>
var board,
  mv_history = "",
  game = new Chess(),
  statusEl = $('#status'),
  fenEl = $('#fen'),
  foeEl = $('#foe'),
  pgnEl = $('#pgn');
  colorEl = $('#color');

// do not pick up pieces if the game is over
// only pick up pieces for the side to move
var onDragStart = function(source, piece, position, orientation) {
  if (game.game_over() === true ||
      (game.turn() === 'w' && board.orientation().search(/^b/) !== -1) ||
      (game.turn() === 'b' && board.orientation().search(/^w/) !== -1) ||
      (game.turn() === 'w' && piece.search(/^b/) !== -1) ||
      (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
    return false;
  }
};

var onDrop = function(source, target) {
  // see if the move is legal
  var move = game.move({
    from: source,
    to: target,
    promotion: 'q' // NOTE: always promote to a queen for example simplicity
  });

  // illegal move
  if (move === null) return 'snapback';
  if ('promotion' in move) {
      target += move.promotion;
  }
  mv_history += source + target + " ";
  console.log("my mr begin from: " + source + " to: " + target + " promo: q");
  console.log(move);
  console.log("my mr end");
  console.log("game fen: " + game.fen())
 
  updateStatus();
};

// update the board position after the piece snap
// for castling, en passant, pawn promotion
var onSnapEnd = function() {
  board.position(game.fen());
  if (conn)
    conn.send(JSON.stringify({Cmd:'move', Params: game.pgn(), MVH: mv_history}));
};

var updateStatus = function() {
  var status = '';

  var moveColor = 'White';
  if (game.turn() === 'b') {
    moveColor = 'Black';
  }

  // checkmate?
  if (game.in_checkmate() === true) {
    status = 'Game over, ' + moveColor + ' is in checkmate.';
  }

  // draw?
  else if (game.in_draw() === true) {
    status = 'Game over, drawn position';
  }

  // game still on
  else {
    status = moveColor + ' to move';

    // check?
    if (game.in_check() === true) {
      status += ', ' + moveColor + ' is in check';
    }
  }

  statusEl.html(status);
  fenEl.html(game.fen());
  pgnEl.html(game.pgn());
};


$('#startBtn').on('click', function() {
    mv_history = "";
    if (board) {
        board.start;
    }

    if (conn) {
        statusEl.html("Waiting for a match...");
        conn.send(JSON.stringify({Cmd: "start"}));
    } else {
        statusEl.html("No connection to server");
    }
});
$('#clearBtn').on('click', function() {
    if (board) {
        board.clear;
    }
});

if (window["WebSocket"]) {
    conn = new WebSocket("ws://" + document.location.host + "/ws");
    conn.onclose = function (evt) {
        statusEl.html("<b>Connection closed.</b>");
    };
    conn.onmessage = function (evt) {
        console.log(evt.data);
        var msg = JSON.parse(evt.data);
        if (msg.Cmd == "start") {
            foeEl.html(msg.User);
            colorEl.html('You are ' + msg.Color)
            var cfg = {
                draggable: true,
                position: 'start',
                orientation: msg.Color,
                onDragStart: onDragStart,
                onDrop: onDrop,
                onSnapEnd: onSnapEnd
            };
            board = ChessBoard('board', cfg);

            updateStatus();
        } else if (msg.Cmd == "move") {
			var from_sq = msg.Params[0] + msg.Params[1];
			mv_history  += from_sq;
            var to_sq   = msg.Params[2] + msg.Params[3];
			mv_history  += to_sq;
			var promotePiece = "q";
			if (msg.Params.length > 4) {
                if (msg.Params[4] == "=")
                    promotePiece = msg.Params[5];
                else
                    promotePiece = msg.Params[4];
			    mv_history += "=" + promotePiece
            }
			mv_history += " "
			var mr = game.move({
               from: from_sq,
               to: to_sq,
               promotion: promotePiece
            });
            console.log("computa mr begin from: " + from_sq + " to: " + to_sq + " promo: " + promotePiece);
            console.log(mr);
            console.log("computa mr end");
			console.log("game fen: " + game.fen())
            updateStatus();
            board.position(game.fen());
        }
    };
} else {
    statusEl.html("<b>Your browser does not support WebSockets.</b>");
}
</script>
</body>
</html>
